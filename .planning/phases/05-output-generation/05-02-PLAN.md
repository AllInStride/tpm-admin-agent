---
phase: 05-output-generation
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/adapters/base.py
  - src/adapters/sheets_adapter.py
  - src/adapters/drive_adapter.py
  - src/adapters/__init__.py
  - tests/test_sheets_adapter.py
  - tests/test_drive_adapter.py
autonomous: true

must_haves:
  truths:
    - "SheetsAdapter can batch write RAID items to Google Sheets"
    - "DriveAdapter can upload meeting minutes to Google Drive"
    - "Adapters support dry-run mode for testing"
    - "Adapters handle missing credentials gracefully"
    - "Write operations are async (non-blocking)"
  artifacts:
    - path: "src/adapters/base.py"
      provides: "OutputAdapter Protocol and WriteResult model"
      exports: ["OutputAdapter", "WriteResult"]
    - path: "src/adapters/sheets_adapter.py"
      provides: "Google Sheets write adapter"
      exports: ["SheetsAdapter"]
    - path: "src/adapters/drive_adapter.py"
      provides: "Google Drive upload adapter"
      exports: ["DriveAdapter"]
  key_links:
    - from: "src/adapters/sheets_adapter.py"
      to: "gspread"
      via: "batch_update API"
      pattern: "batch_update"
    - from: "src/adapters/drive_adapter.py"
      to: "googleapiclient.discovery"
      via: "Drive API files().create()"
      pattern: "files\\(\\).create"
    - from: "src/adapters/sheets_adapter.py"
      to: "asyncio.to_thread"
      via: "async wrapper for sync gspread"
      pattern: "asyncio.to_thread"
---

<objective>
Create output adapters for Google Sheets and Google Drive following the established adapter pattern.

Purpose: Enable writing RAID items to Google Sheets for tracking and uploading meeting minutes to Google Drive. These adapters implement the OutputAdapter protocol for consistent interface.

Output: SheetsAdapter for batch RAID writes, DriveAdapter for minutes upload, both with async methods, dry-run support, and proper error handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-output-generation/05-CONTEXT.md
@.planning/phases/05-output-generation/05-RESEARCH.md

@src/adapters/roster_adapter.py (pattern reference)
@src/adapters/calendar_adapter.py (pattern reference)
@src/output/schemas.py (RaidBundle, RenderedMinutes)
</context>

<tasks>

<task type="auto">
  <name>Task 1: OutputAdapter protocol and WriteResult</name>
  <files>
    src/adapters/base.py
    src/adapters/__init__.py
  </files>
  <action>
    1. Create src/adapters/base.py with:

       WriteResult (Pydantic model):
       - success: bool
       - dry_run: bool = False
       - item_count: int = 0
       - external_id: str | None = None (Sheet ID, file ID)
       - url: str | None = None (web view link)
       - error_message: str | None = None
       - duration_ms: int | None = None

       OutputAdapter (Protocol with @runtime_checkable):
       - async def write(self, data: dict, destination: str, *, dry_run: bool = False) -> WriteResult
       - async def health_check(self) -> bool

       Note: Protocol allows structural subtyping - adapters don't need to inherit, just implement the methods.

    2. Update src/adapters/__init__.py to export:
       - OutputAdapter
       - WriteResult
       - (keep existing RosterAdapter, SlackAdapter, CalendarAdapter exports)
  </action>
  <verify>
    Run: python -c "
from src.adapters import OutputAdapter, WriteResult
from typing import runtime_checkable
print('Protocol and WriteResult imported OK')
"
  </verify>
  <done>
    - OutputAdapter protocol defined with write() and health_check()
    - WriteResult captures all write metadata
    - Protocol is @runtime_checkable
  </done>
</task>

<task type="auto">
  <name>Task 2: SheetsAdapter for RAID item writes</name>
  <files>
    src/adapters/sheets_adapter.py
    tests/test_sheets_adapter.py
  </files>
  <action>
    1. Create src/adapters/sheets_adapter.py following RosterAdapter pattern:

       SheetsAdapter class:
       - SCOPES: includes spreadsheets and drive.file (for creating sheets)
       - __init__(self, credentials_path: str | None = None): Falls back to GOOGLE_SHEETS_CREDENTIALS env var
       - _get_client() -> gspread.Client: Lazy initialization, clear error if no credentials

       async def write_raid_items(
           self,
           spreadsheet_id: str,
           items: list[dict],
           sheet_name: str = "RAID",
           *,
           dry_run: bool = False,
       ) -> WriteResult:
       - If dry_run: log and return success immediately
       - Use asyncio.to_thread() to call sync _write_sync method
       - Return WriteResult with item_count

       def _write_sync(self, spreadsheet_id: str, items: list[dict], sheet_name: str) -> WriteResult:
       - Get or create worksheet
       - Prepare header row if sheet is empty: [UUID, Type, Description, Owner, Due Date, Status, Confidence]
       - Prepare data rows from items (UUID in first column for upsert capability)
       - Use batch_update with value_input_option="USER_ENTERED" for single API call
       - Log write with structlog
       - Return WriteResult

       async def health_check(self) -> bool:
       - Try to authenticate client
       - Return True if successful, False if credentials fail

    2. Create tests/test_sheets_adapter.py:
       - test_write_raid_items_dry_run(): Verify dry run returns success without API call
       - test_write_raid_items_with_mock(): Mock gspread, verify batch_update called correctly
       - test_write_result_fields(): Verify WriteResult populated correctly
       - test_missing_credentials_error(): Verify clear error when no credentials
       - test_health_check_success(): Mock successful auth
       - test_health_check_failure(): Mock failed auth

       Use unittest.mock to patch gspread.authorize and gspread.Client methods.
       DO NOT make real API calls in tests.

    3. Update src/adapters/__init__.py to export SheetsAdapter.
  </action>
  <verify>
    Run: cd /Users/gabrielguenette/projects/tpm-admin-agent && uv run pytest tests/test_sheets_adapter.py -v
  </verify>
  <done>
    - SheetsAdapter follows established adapter pattern
    - Batch writes use single API call
    - Dry-run mode works without credentials
    - 6 tests pass with mocked API
  </done>
</task>

<task type="auto">
  <name>Task 3: DriveAdapter for minutes upload</name>
  <files>
    src/adapters/drive_adapter.py
    tests/test_drive_adapter.py
  </files>
  <action>
    1. Create src/adapters/drive_adapter.py following CalendarAdapter pattern:

       DriveAdapter class:
       - SCOPES: ["https://www.googleapis.com/auth/drive.file"]
       - __init__(self, credentials_path: str | None = None):
         Falls back to GOOGLE_DRIVE_CREDENTIALS, then GOOGLE_SHEETS_CREDENTIALS (reuse existing creds)
       - _get_service() -> Resource: Lazy initialization of Drive API service

       async def upload_minutes(
           self,
           content: str,
           filename: str,
           folder_id: str,
           mime_type: str = "text/markdown",
           *,
           dry_run: bool = False,
       ) -> WriteResult:
       - If dry_run: log and return success immediately
       - Use asyncio.to_thread() to call sync _upload_sync method
       - Return WriteResult with external_id (file ID) and url (webViewLink)

       def _upload_sync(
           self,
           content: str,
           filename: str,
           folder_id: str,
           mime_type: str,
       ) -> WriteResult:
       - Create file metadata with name and parent folder
       - Use MediaIoBaseUpload with BytesIO(content.encode("utf-8"))
       - Call files().create() with fields="id,webViewLink"
       - Log upload with structlog
       - Return WriteResult with file ID and URL

       async def health_check(self) -> bool:
       - Try to initialize service
       - Return True if successful

    2. Create tests/test_drive_adapter.py:
       - test_upload_minutes_dry_run(): Verify dry run returns success
       - test_upload_minutes_with_mock(): Mock Drive API, verify create called correctly
       - test_upload_returns_file_id(): Verify external_id populated from API response
       - test_upload_returns_web_link(): Verify url populated
       - test_missing_credentials_error(): Verify clear error
       - test_health_check_success(): Mock successful auth
       - test_mime_type_options(): Verify text/markdown and text/html work

       Use unittest.mock to patch googleapiclient.discovery.build.
       DO NOT make real API calls in tests.

    3. Update src/adapters/__init__.py to export DriveAdapter.
  </action>
  <verify>
    Run: cd /Users/gabrielguenette/projects/tpm-admin-agent && uv run pytest tests/test_drive_adapter.py -v
  </verify>
  <done>
    - DriveAdapter uploads files to Google Drive
    - Returns file ID and web view link
    - Dry-run mode works
    - 7 tests pass with mocked API
  </done>
</task>

</tasks>

<verification>
1. `python -c "from src.adapters import OutputAdapter, WriteResult, SheetsAdapter, DriveAdapter"` works
2. `uv run pytest tests/test_sheets_adapter.py tests/test_drive_adapter.py -v` - all tests pass
3. Dry-run mode works for both adapters (no credentials needed)
4. Both adapters use asyncio.to_thread for non-blocking I/O
5. Error messages are clear when credentials missing
</verification>

<success_criteria>
- OutputAdapter protocol defined with write() and health_check()
- WriteResult model captures success, external_id, url, error info
- SheetsAdapter batch writes RAID items with single API call
- DriveAdapter uploads meeting minutes with file ID and URL returned
- Both adapters support dry-run mode
- Both adapters use asyncio.to_thread for async wrappers
- 13+ tests pass covering both adapters
</success_criteria>

<output>
After completion, create `.planning/phases/05-output-generation/05-02-SUMMARY.md`
</output>
