---
phase: 05-output-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/output/__init__.py
  - src/output/schemas.py
  - src/output/renderer.py
  - templates/default_minutes.md.j2
  - templates/default_minutes.html.j2
  - pyproject.toml
  - tests/test_output_renderer.py
autonomous: true

must_haves:
  truths:
    - "Renderer produces Markdown meeting minutes from RAID data"
    - "Renderer produces HTML meeting minutes with same content"
    - "Low-confidence items (< 0.7) are visually marked"
    - "Missing due dates show TBD placeholder"
    - "D-A-R-I section order is enforced"
  artifacts:
    - path: "src/output/schemas.py"
      provides: "MinutesContext, RenderedMinutes data models"
      exports: ["MinutesContext", "RenderedMinutes", "RaidBundle"]
    - path: "src/output/renderer.py"
      provides: "Jinja2 template rendering"
      exports: ["MinutesRenderer"]
    - path: "templates/default_minutes.md.j2"
      provides: "Default Markdown template"
      contains: "{{ meeting_title }}"
    - path: "templates/default_minutes.html.j2"
      provides: "Default HTML template"
      contains: "{{ meeting_title }}"
  key_links:
    - from: "src/output/renderer.py"
      to: "templates/*.j2"
      via: "Jinja2 FileSystemLoader"
      pattern: "FileSystemLoader"
    - from: "src/output/renderer.py"
      to: "src/output/schemas.py"
      via: "MinutesContext import"
      pattern: "from src.output.schemas import"
---

<objective>
Create output data schemas and Jinja2-based template renderer for meeting minutes.

Purpose: Enable generation of meeting minutes from extracted RAID artifacts in both Markdown and HTML formats. This establishes the foundation for the output generation pipeline.

Output: MinutesRenderer class that renders meeting data to formatted minutes using customizable Jinja2 templates, plus default templates for both formats.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-output-generation/05-CONTEXT.md
@.planning/phases/05-output-generation/05-RESEARCH.md

@src/models/action_item.py
@src/models/decision.py
@src/models/risk.py
@src/models/issue.py
@src/models/meeting.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Output schemas and Jinja2 dependency</name>
  <files>
    src/output/__init__.py
    src/output/schemas.py
    pyproject.toml
  </files>
  <action>
    1. Add Jinja2 and tenacity to pyproject.toml dependencies:
       - "jinja2>=3.1.0"
       - "tenacity>=9.0.0"

    2. Create src/output/ module with __init__.py exporting public types.

    3. Create src/output/schemas.py with Pydantic models:

       MinutesContext:
       - meeting_id: UUID
       - meeting_title: str
       - meeting_date: datetime
       - duration_minutes: int | None
       - attendees: list[str] (names with roles if available, e.g., "John Smith (PM)")
       - decisions: list[DecisionItem]
       - action_items: list[ActionItemData]
       - risks: list[RiskItem]
       - issues: list[IssueItem]
       - next_steps: list[str] (top 3-5 action item descriptions)
       - generated_at: datetime = Field(default_factory=datetime.utcnow)

       DecisionItem (for template rendering - flattened from domain model):
       - description: str
       - rationale: str | None
       - alternatives: list[str]
       - confidence: float

       ActionItemData (for template rendering):
       - description: str
       - assignee_name: str | None
       - due_date: str | None (formatted string or "TBD")
       - confidence: float

       RiskItem (for template rendering):
       - description: str
       - severity: str (uppercase)
       - owner_name: str | None
       - mitigation: str | None
       - confidence: float

       IssueItem (for template rendering):
       - description: str
       - priority: str (uppercase)
       - status: str
       - owner_name: str | None
       - impact: str | None
       - confidence: float

       RenderedMinutes:
       - meeting_id: UUID
       - markdown: str
       - html: str
       - template_used: str

       RaidBundle (for passing to Sheets adapter):
       - meeting_id: UUID
       - decisions: list[DecisionItem]
       - action_items: list[ActionItemData]
       - risks: list[RiskItem]
       - issues: list[IssueItem]

       Add class methods to MinutesContext:
       - from_meeting_data(meeting: Meeting, decisions: list[Decision], action_items: list[ActionItem], risks: list[Risk], issues: list[Issue]) -> MinutesContext
         (converts domain models to template-friendly format, generates next_steps from top 3-5 action items)
  </action>
  <verify>
    Run: uv pip install -e . && python -c "from src.output.schemas import MinutesContext, RenderedMinutes, RaidBundle; print('OK')"
  </verify>
  <done>
    - MinutesContext can be instantiated with meeting data
    - from_meeting_data() converts domain models correctly
    - next_steps auto-generated from action items
    - All schema fields validate
  </done>
</task>

<task type="auto">
  <name>Task 2: Jinja2 renderer and default templates</name>
  <files>
    src/output/renderer.py
    templates/default_minutes.md.j2
    templates/default_minutes.html.j2
  </files>
  <action>
    1. Create templates/ directory at project root.

    2. Create templates/default_minutes.md.j2 with:
       - Header: Meeting title, date, duration, attendees
       - D-A-R-I section order (Decisions, Actions, Risks, Issues)
       - Visual indicator [LOW CONFIDENCE] for items with confidence < 0.7
       - Action items in table format with Owner, Due Date columns
       - "TBD" for missing due dates, "Unassigned" for missing owners
       - Next Steps section at end (numbered list)
       - Generated timestamp at bottom
       (Use template from RESEARCH.md as starting point)

    3. Create templates/default_minutes.html.j2 with:
       - Same structure as Markdown but with HTML tags
       - Inline CSS for styling (per RESEARCH.md - portable)
       - Clean, professional styling: sans-serif font, subtle colors
       - Table styling for action items
       - Low confidence indicator as subtle red text
       - Print-friendly: avoid bright colors, good contrast

    4. Create src/output/renderer.py with MinutesRenderer class:

       __init__(self, template_dir: str = "templates"):
       - Set up Jinja2 Environment with FileSystemLoader
       - Enable autoescape for HTML templates
       - Set trim_blocks=True, lstrip_blocks=True for cleaner output

       render(self, context: MinutesContext, template_name: str = "default_minutes") -> RenderedMinutes:
       - Load both .md.j2 and .html.j2 templates
       - Render context.model_dump() through both
       - Return RenderedMinutes with both formats and template name

       render_markdown(self, context: MinutesContext, template_name: str = "default_minutes") -> str:
       - Load {template_name}.md.j2
       - Render and return Markdown string

       render_html(self, context: MinutesContext, template_name: str = "default_minutes") -> str:
       - Load {template_name}.html.j2
       - Render and return HTML string

    5. Update src/output/__init__.py to export MinutesRenderer.
  </action>
  <verify>
    Run: python -c "
from src.output.renderer import MinutesRenderer
from src.output.schemas import MinutesContext
from uuid import uuid4
from datetime import datetime

ctx = MinutesContext(
    meeting_id=uuid4(),
    meeting_title='Test Meeting',
    meeting_date=datetime.now(),
    duration_minutes=60,
    attendees=['Alice (PM)', 'Bob (Dev)'],
    decisions=[],
    action_items=[],
    risks=[],
    issues=[],
    next_steps=[]
)
renderer = MinutesRenderer()
result = renderer.render(ctx)
assert 'Test Meeting' in result.markdown
assert 'Test Meeting' in result.html
print('Renderer OK')
"
  </verify>
  <done>
    - MinutesRenderer renders both Markdown and HTML
    - D-A-R-I section order in both templates
    - Low confidence items marked visually
    - TBD shown for missing due dates
    - Generated timestamp appears in output
  </done>
</task>

<task type="auto">
  <name>Task 3: Renderer tests</name>
  <files>
    tests/test_output_renderer.py
  </files>
  <action>
    Create comprehensive tests for the renderer:

    1. test_render_empty_meeting():
       - Create MinutesContext with empty RAID lists
       - Verify "No decisions recorded", "No action items recorded" text appears
       - Verify both Markdown and HTML render without error

    2. test_render_with_raid_items():
       - Create context with 1 of each RAID type
       - Verify all items appear in output
       - Verify D-A-R-I section order (Decisions before Actions before Risks before Issues)

    3. test_low_confidence_marking():
       - Create action item with confidence 0.6
       - Create decision with confidence 0.8 (above threshold)
       - Verify low confidence item has "[LOW CONFIDENCE]" or "[?]" marker
       - Verify high confidence item has no marker

    4. test_missing_due_date_shows_tbd():
       - Create action item with due_date=None
       - Verify "TBD" appears in rendered output

    5. test_missing_assignee_shows_unassigned():
       - Create action item with assignee_name=None
       - Verify "Unassigned" appears in output

    6. test_next_steps_generation():
       - Create context with 7 action items
       - Verify only top 5 appear in next_steps section

    7. test_from_meeting_data():
       - Create domain models (Meeting, ActionItem, Decision, Risk, Issue)
       - Call MinutesContext.from_meeting_data()
       - Verify conversion is correct
       - Verify next_steps auto-populated

    8. test_html_has_styling():
       - Render HTML output
       - Verify CSS styles present (font-family, table styling)

    9. test_custom_template_name():
       - Verify renderer can load template by name
       - Verify error raised for non-existent template

    10. test_attendees_format():
        - Verify attendees rendered as comma-separated list
  </action>
  <verify>
    Run: cd /Users/gabrielguenette/projects/tpm-admin-agent && uv run pytest tests/test_output_renderer.py -v
  </verify>
  <done>
    - All 10 tests pass
    - Renderer handles edge cases (empty data, missing fields)
    - D-A-R-I order verified
    - Low confidence marking works at 0.7 threshold
  </done>
</task>

</tasks>

<verification>
1. `uv pip install -e .` succeeds with new dependencies
2. `python -c "from src.output import MinutesRenderer, MinutesContext"` works
3. `uv run pytest tests/test_output_renderer.py -v` - all tests pass
4. Rendered Markdown is valid (no syntax errors)
5. Rendered HTML is valid (no unclosed tags)
</verification>

<success_criteria>
- Jinja2 and tenacity dependencies added to pyproject.toml
- MinutesContext can convert domain models to template-friendly format
- MinutesRenderer renders both Markdown and HTML from same context
- Default templates follow D-A-R-I order with all required sections
- Low-confidence items (< 0.7) are visually marked
- 10+ tests pass covering renderer functionality
</success_criteria>

<output>
After completion, create `.planning/phases/05-output-generation/05-01-SUMMARY.md`
</output>
