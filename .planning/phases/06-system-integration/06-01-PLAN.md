---
phase: 06-system-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/adapters/smartsheet_adapter.py
  - src/adapters/__init__.py
  - src/integration/__init__.py
  - src/integration/schemas.py
  - tests/adapters/test_smartsheet_adapter.py
autonomous: true
user_setup:
  - service: smartsheet
    why: "RAID item tracking"
    env_vars:
      - name: SMARTSHEET_ACCESS_TOKEN
        source: "Smartsheet Account > Personal Settings > API Access > Generate token"
    dashboard_config:
      - task: "Create folder for RAID sheets (optional)"
        location: "Smartsheet > Home > Create > Folder"

must_haves:
  truths:
    - "SmartsheetAdapter can create sheets with RAID columns"
    - "SmartsheetAdapter can add rows in batches"
    - "SmartsheetAdapter handles rate limiting gracefully"
    - "Column mapping works dynamically (title to ID)"
  artifacts:
    - path: "src/adapters/smartsheet_adapter.py"
      provides: "SmartsheetAdapter class"
      exports: ["SmartsheetAdapter"]
    - path: "src/integration/schemas.py"
      provides: "Integration-specific schemas"
      exports: ["SmartsheetConfig", "SmartsheetWriteResult"]
  key_links:
    - from: "src/adapters/smartsheet_adapter.py"
      to: "smartsheet.Smartsheet"
      via: "SDK client"
      pattern: "smartsheet\\.Smartsheet"
    - from: "src/adapters/smartsheet_adapter.py"
      to: "asyncio.to_thread"
      via: "non-blocking I/O"
      pattern: "asyncio\\.to_thread"
---

<objective>
Create SmartsheetAdapter for writing RAID items to Smartsheet.

Purpose: Enable automatic creation of Smartsheet rows from extracted RAID artifacts.
Output: SmartsheetAdapter class with sheet creation, column mapping, and batch row writes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-system-integration/06-CONTEXT.md
@.planning/phases/06-system-integration/06-RESEARCH.md
@src/adapters/base.py
@src/adapters/sheets_adapter.py
@src/output/queue.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add smartsheet-python-sdk dependency and create integration schemas</name>
  <files>
    - pyproject.toml
    - src/integration/__init__.py
    - src/integration/schemas.py
  </files>
  <action>
1. Add `smartsheet-python-sdk>=3.7.1` to pyproject.toml dependencies

2. Create `src/integration/` package with `__init__.py`

3. Create `src/integration/schemas.py` with:
   - `SmartsheetConfig` model: sheet_id (int|None), folder_id (int|None), auto_create (bool, default True)
   - `SmartsheetWriteResult` extending WriteResult: row_ids (list[int]), sheet_url (str|None)
   - `RaidRowData` model for row mapping: type, title, owner, status, due_date, source_meeting, created_date, confidence, item_hash (for dedup)
   - `RAID_COLUMNS` constant: list of column definitions per CONTEXT.md (Type, Title, Owner, Status, Due Date, Source Meeting, Created Date, Confidence)
   - Column type mapping using smartsheet column types (PICKLIST for Type/Status, DATE for dates, CONTACT_LIST for Owner, TEXT_NUMBER for others)

4. Run `uv sync` to install dependency
  </action>
  <verify>`uv run python -c "import smartsheet; print(smartsheet.__version__)"` succeeds</verify>
  <done>smartsheet-python-sdk installed, integration schemas created with column definitions</done>
</task>

<task type="auto">
  <name>Task 2: Implement SmartsheetAdapter with batch row writes</name>
  <files>
    - src/adapters/smartsheet_adapter.py
    - src/adapters/__init__.py
  </files>
  <action>
1. Create `src/adapters/smartsheet_adapter.py`:

```python
class SmartsheetAdapter:
    """Adapter for writing RAID items to Smartsheet."""

    BATCH_SIZE = 100  # Conservative batch size (API max is 500)

    def __init__(self, access_token: str | None = None):
        self._token = access_token or os.environ.get("SMARTSHEET_ACCESS_TOKEN")
        self._client: smartsheet.Smartsheet | None = None

    def _get_client(self) -> smartsheet.Smartsheet:
        # Lazy initialization with token validation

    async def create_sheet(
        self,
        name: str,
        folder_id: int | None = None,
        *,
        dry_run: bool = False,
    ) -> SmartsheetWriteResult:
        # Create sheet with RAID_COLUMNS in folder
        # Use asyncio.to_thread for sync SDK call

    async def write_raid_items(
        self,
        sheet_id: int,
        items: list[RaidRowData],
        *,
        dry_run: bool = False,
    ) -> SmartsheetWriteResult:
        # Batch write with chunking
        # Dynamic column ID lookup

    def _write_batch_sync(
        self,
        sheet_id: int,
        items: list[RaidRowData],
        column_map: dict[str, int],
    ) -> list[int]:
        # Sync batch write for asyncio.to_thread

    def _get_column_map(self, sheet_id: int) -> dict[str, int]:
        # Fetch sheet columns, return title -> id map

    def _item_to_row(
        self,
        item: RaidRowData,
        column_map: dict[str, int],
    ) -> smartsheet.models.Row:
        # Convert RaidRowData to Smartsheet Row
        # row.to_bottom = True (per RESEARCH.md)
        # Format dates as ISO strings

    async def health_check(self) -> bool:
        # Verify API access with simple API call
```

2. Key implementation details:
   - Use `asyncio.to_thread()` for all sync SDK calls (SDK is synchronous)
   - Chunk items into BATCH_SIZE groups for add_rows calls
   - SDK has built-in retry for rate limits, but wrap with tenacity for transient failures
   - Column IDs are sheet-specific - must fetch dynamically
   - Set `row.to_bottom = True` for new rows (per RESEARCH.md pitfall)
   - Format dates as ISO strings (YYYY-MM-DD) for DATE columns
   - Include item_hash in a hidden/text column for dedup lookups

3. Update `src/adapters/__init__.py` to export SmartsheetAdapter
  </action>
  <verify>`uv run python -c "from src.adapters import SmartsheetAdapter; print('OK')"` succeeds</verify>
  <done>SmartsheetAdapter created with create_sheet, write_raid_items, and health_check methods</done>
</task>

<task type="auto">
  <name>Task 3: Add SmartsheetAdapter tests</name>
  <files>
    - tests/adapters/test_smartsheet_adapter.py
  </files>
  <action>
1. Create `tests/adapters/test_smartsheet_adapter.py` with:

Test fixtures:
- `mock_smartsheet_client`: Mock smartsheet.Smartsheet
- `smartsheet_adapter`: SmartsheetAdapter with mocked client
- `sample_raid_items`: List of RaidRowData for testing

Test cases:
- `test_create_sheet_success`: Verify sheet creation with columns
- `test_create_sheet_dry_run`: Verify dry run returns success without API call
- `test_write_raid_items_success`: Verify batch write with multiple items
- `test_write_raid_items_batching`: Verify items chunked at BATCH_SIZE
- `test_write_raid_items_empty_list`: Verify empty items returns success with 0 count
- `test_column_map_fetched`: Verify column IDs fetched from sheet
- `test_item_to_row_mapping`: Verify RaidRowData converts to Row cells correctly
- `test_date_format_iso`: Verify dates formatted as YYYY-MM-DD
- `test_health_check_success`: Verify health check returns True
- `test_health_check_no_token`: Verify health check returns False without token
- `test_adapter_no_token_raises`: Verify ValueError when no token configured

2. Mock strategy:
   - Mock `smartsheet.Smartsheet` class entirely
   - Mock `Sheets.get_sheet()` to return sheet with columns
   - Mock `Sheets.add_rows()` to return success response
   - Mock `Folders.create_sheet_in_folder()` for sheet creation

3. Run tests: `uv run pytest tests/adapters/test_smartsheet_adapter.py -v`
  </action>
  <verify>`uv run pytest tests/adapters/test_smartsheet_adapter.py -v` - all tests pass</verify>
  <done>SmartsheetAdapter has comprehensive test coverage for create, write, and health operations</done>
</task>

</tasks>

<verification>
1. `uv run python -c "import smartsheet"` - SDK installed
2. `uv run python -c "from src.adapters import SmartsheetAdapter"` - adapter importable
3. `uv run pytest tests/adapters/test_smartsheet_adapter.py -v` - tests pass
4. `uv run pytest` - full test suite passes (no regressions)
</verification>

<success_criteria>
- smartsheet-python-sdk dependency added and installed
- SmartsheetAdapter follows OutputAdapter pattern (write, health_check)
- Adapter supports sheet creation with RAID columns
- Adapter batches row writes (100 items per call)
- Column mapping is dynamic (fetches from sheet)
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-system-integration/06-01-SUMMARY.md`
</output>
