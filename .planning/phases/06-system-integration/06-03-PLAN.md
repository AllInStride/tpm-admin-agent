---
phase: 06-system-integration
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - src/output/config.py
  - src/output/router.py
  - src/integration/integration_router.py
  - src/api/integration.py
  - src/api/router.py
  - tests/api/test_integration.py
autonomous: true

must_haves:
  truths:
    - "System creates rows in Smartsheet for action items, risks, and issues"
    - "System notifies owners of assigned items via Slack"
    - "Notification includes item description, due date, and link to Smartsheet"
    - "System handles Smartsheet rate limiting gracefully"
  artifacts:
    - path: "src/integration/integration_router.py"
      provides: "IntegrationRouter orchestrating Smartsheet + Slack"
      exports: ["IntegrationRouter"]
    - path: "src/api/integration.py"
      provides: "POST /integration endpoint"
      exports: ["router"]
  key_links:
    - from: "src/integration/integration_router.py"
      to: "src/adapters/smartsheet_adapter.py"
      via: "SmartsheetAdapter.write_raid_items"
      pattern: "smartsheet_adapter\\.write_raid_items"
    - from: "src/integration/integration_router.py"
      to: "src/integration/notification_service.py"
      via: "NotificationService.notify_owner"
      pattern: "notification_service\\.notify_owner"
    - from: "src/api/integration.py"
      to: "src/integration/integration_router.py"
      via: "IntegrationRouter.process"
      pattern: "router\\.process"
---

<objective>
Wire SmartsheetAdapter and NotificationService into output pipeline with API endpoint.

Purpose: Complete the integration - extracted RAID items flow to Smartsheet, owners get notified.
Output: IntegrationRouter orchestrating both systems, POST /integration API endpoint.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-system-integration/06-CONTEXT.md
@.planning/phases/06-system-integration/06-RESEARCH.md
@.planning/phases/06-system-integration/06-01-SUMMARY.md
@.planning/phases/06-system-integration/06-02-SUMMARY.md
@src/output/router.py
@src/output/config.py
@src/api/output.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend ProjectOutputConfig and create IntegrationRouter</name>
  <files>
    - src/output/config.py
    - src/integration/integration_router.py
    - src/integration/__init__.py
  </files>
  <action>
1. Extend `src/output/config.py` ProjectOutputConfig:

```python
class ProjectOutputConfig(BaseModel):
    # ... existing fields ...

    # Smartsheet settings
    smartsheet_sheet_id: int | None = Field(
        default=None, description="Smartsheet sheet ID for RAID items"
    )
    smartsheet_folder_id: int | None = Field(
        default=None, description="Folder ID for auto-creating sheets"
    )
    auto_create_sheet: bool = Field(
        default=True, description="Auto-create sheet if missing"
    )

    # Notification settings
    notify_owners: bool = Field(
        default=True, description="Send Slack DMs to action item owners"
    )
    fallback_email: str | None = Field(
        default=None, description="Fallback email for unresolved owners"
    )
```

2. Create `src/integration/integration_router.py`:

```python
class IntegrationResult(BaseModel):
    """Result of full integration pipeline."""
    smartsheet_result: SmartsheetWriteResult | None = None
    notifications_sent: int = 0
    notifications_failed: int = 0
    notification_results: list[NotificationResult] = []

class IntegrationRouter:
    """Orchestrates Smartsheet writes and owner notifications."""

    def __init__(
        self,
        smartsheet_adapter: SmartsheetAdapter | None = None,
        notification_service: NotificationService | None = None,
    ):
        self.smartsheet = smartsheet_adapter
        self.notifications = notification_service

    async def process(
        self,
        raid_bundle: RaidBundle,
        config: ProjectOutputConfig,
        *,
        dry_run: bool = False,
    ) -> IntegrationResult:
        """Process RAID items through Smartsheet and notifications.

        1. Convert RaidBundle to RaidRowData list
        2. Write to Smartsheet (creates sheet if needed)
        3. Send notifications to action item owners
        4. Return aggregated results
        """
        result = IntegrationResult()

        # Convert bundle to row data
        rows = self._bundle_to_rows(raid_bundle)

        # Write to Smartsheet
        if self.smartsheet and config.smartsheet_sheet_id:
            ss_result = await self._write_to_smartsheet(
                rows, config, dry_run=dry_run
            )
            result.smartsheet_result = ss_result
            smartsheet_url = ss_result.sheet_url if ss_result.success else None
        else:
            smartsheet_url = None

        # Send notifications for action items
        if self.notifications and config.notify_owners and not dry_run:
            notif_results = await self._send_notifications(
                raid_bundle.action_items,
                smartsheet_url,
                config.fallback_email,
            )
            result.notification_results = notif_results
            result.notifications_sent = sum(1 for r in notif_results if r.success)
            result.notifications_failed = sum(1 for r in notif_results if not r.success)

        return result

    async def _write_to_smartsheet(
        self,
        rows: list[RaidRowData],
        config: ProjectOutputConfig,
        *,
        dry_run: bool = False,
    ) -> SmartsheetWriteResult:
        """Write RAID rows to Smartsheet with optional sheet creation."""
        sheet_id = config.smartsheet_sheet_id

        # Auto-create sheet if needed and enabled
        if not sheet_id and config.auto_create_sheet and config.smartsheet_folder_id:
            create_result = await self.smartsheet.create_sheet(
                name=f"RAID Log - {datetime.now().strftime('%Y-%m-%d')}",
                folder_id=config.smartsheet_folder_id,
                dry_run=dry_run,
            )
            if create_result.success:
                sheet_id = int(create_result.external_id) if create_result.external_id else None

        if not sheet_id:
            return SmartsheetWriteResult(
                success=False,
                error_message="No Smartsheet sheet ID configured",
            )

        # Write with retry (tenacity decorator)
        @write_with_retry
        async def write():
            return await self.smartsheet.write_raid_items(
                sheet_id, rows, dry_run=dry_run
            )

        return await write()

    async def _send_notifications(
        self,
        action_items: list[ActionItemData],
        smartsheet_url: str | None,
        fallback_email: str | None,
    ) -> list[NotificationResult]:
        """Send notifications to action item owners."""
        results = []
        for item in action_items:
            # Skip items without assignee
            if not item.assignee_name:
                continue

            # Resolve email (for now, assume assignee_name is email or use fallback)
            # Future: integrate with identity resolution
            email = item.assignee_name if "@" in item.assignee_name else fallback_email

            if not email:
                results.append(NotificationResult(
                    success=False,
                    recipient_email="",
                    error="no_email_available",
                ))
                continue

            result = await self.notifications.notify_owner(
                owner_email=email,
                item=item,
                smartsheet_url=smartsheet_url,
            )
            results.append(result)

        return results

    def _bundle_to_rows(self, bundle: RaidBundle) -> list[RaidRowData]:
        """Convert RaidBundle to flat list of RaidRowData."""
        rows = []
        meeting_id = str(bundle.meeting_id)

        for decision in bundle.decisions:
            rows.append(RaidRowData(
                type="Decision",
                title=decision.description,
                owner="",
                status="Documented",
                due_date=None,
                source_meeting=meeting_id,
                confidence=decision.confidence,
            ))

        for action in bundle.action_items:
            rows.append(RaidRowData(
                type="Action",
                title=action.description,
                owner=action.assignee_name or "",
                status="Open",
                due_date=action.due_date,
                source_meeting=meeting_id,
                confidence=action.confidence,
            ))

        for risk in bundle.risks:
            rows.append(RaidRowData(
                type="Risk",
                title=risk.description,
                owner=risk.owner_name or "",
                status="Identified",
                due_date=None,
                source_meeting=meeting_id,
                confidence=risk.confidence,
            ))

        for issue in bundle.issues:
            rows.append(RaidRowData(
                type="Issue",
                title=issue.description,
                owner=issue.owner_name or "",
                status=issue.status if hasattr(issue, 'status') else "Open",
                due_date=None,
                source_meeting=meeting_id,
                confidence=issue.confidence,
            ))

        return rows
```

3. Update `src/integration/__init__.py` to export IntegrationRouter, IntegrationResult
  </action>
  <verify>`uv run python -c "from src.integration import IntegrationRouter; print('OK')"` succeeds</verify>
  <done>IntegrationRouter created orchestrating Smartsheet writes and Slack notifications</done>
</task>

<task type="auto">
  <name>Task 2: Create POST /integration API endpoint</name>
  <files>
    - src/api/integration.py
    - src/api/router.py
  </files>
  <action>
1. Create `src/api/integration.py`:

```python
"""API endpoints for system integration (Smartsheet + Slack)."""

from uuid import UUID

import structlog
from fastapi import APIRouter, HTTPException, Query
from pydantic import BaseModel, Field

from src.adapters import SmartsheetAdapter, SlackAdapter
from src.integration import IntegrationRouter, IntegrationResult, NotificationService
from src.output.config import ProjectOutputConfig
from src.output.schemas import RaidBundle

logger = structlog.get_logger()
router = APIRouter(prefix="/integration", tags=["integration"])


class IntegrationRequest(BaseModel):
    """Request body for integration endpoint."""
    raid_bundle: RaidBundle
    config: ProjectOutputConfig | None = None


class IntegrationHealthResponse(BaseModel):
    """Response for integration health check."""
    smartsheet_configured: bool
    smartsheet_healthy: bool
    slack_configured: bool
    slack_healthy: bool


@router.post("", response_model=IntegrationResult)
async def process_integration(
    request: IntegrationRequest,
    dry_run: bool = Query(default=False, description="Validate without writing"),
) -> IntegrationResult:
    """Process RAID bundle through Smartsheet and Slack notifications.

    Writes RAID items to Smartsheet and sends DMs to action item owners.
    """
    config = request.config or ProjectOutputConfig.default()

    # Initialize adapters (lazy - only if configured)
    smartsheet = SmartsheetAdapter() if config.smartsheet_sheet_id else None
    slack = SlackAdapter() if config.notify_owners else None
    notifications = NotificationService(slack) if slack else None

    integration_router = IntegrationRouter(
        smartsheet_adapter=smartsheet,
        notification_service=notifications,
    )

    try:
        result = await integration_router.process(
            raid_bundle=request.raid_bundle,
            config=config,
            dry_run=dry_run,
        )
        logger.info(
            "integration complete",
            meeting_id=str(request.raid_bundle.meeting_id),
            smartsheet_success=result.smartsheet_result.success if result.smartsheet_result else None,
            notifications_sent=result.notifications_sent,
            dry_run=dry_run,
        )
        return result
    except Exception as e:
        logger.error("integration failed", error=str(e))
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/health", response_model=IntegrationHealthResponse)
async def integration_health() -> IntegrationHealthResponse:
    """Check health of integration adapters."""
    smartsheet = SmartsheetAdapter()
    slack = SlackAdapter()

    ss_configured = smartsheet._token is not None
    ss_healthy = await smartsheet.health_check() if ss_configured else False

    slack_configured = slack._token is not None
    slack_healthy = await slack.health_check() if slack_configured and hasattr(slack, 'health_check') else slack_configured

    return IntegrationHealthResponse(
        smartsheet_configured=ss_configured,
        smartsheet_healthy=ss_healthy,
        slack_configured=slack_configured,
        slack_healthy=slack_healthy,
    )
```

2. Add SlackAdapter health_check method if not present (simple auth test)

3. Update `src/api/router.py` to include integration router:
   - Add import: `from src.api.integration import router as integration_router`
   - Add: `api_router.include_router(integration_router)`
  </action>
  <verify>`uv run python -c "from src.api.integration import router; print(router.routes)"` lists POST and GET routes</verify>
  <done>POST /integration and GET /integration/health endpoints created</done>
</task>

<task type="auto">
  <name>Task 3: Add integration API tests</name>
  <files>
    - tests/api/test_integration.py
  </files>
  <action>
1. Create `tests/api/test_integration.py`:

Test fixtures:
- `mock_smartsheet_adapter`: Mocked SmartsheetAdapter
- `mock_slack_adapter`: Mocked SlackAdapter
- `mock_notification_service`: Mocked NotificationService
- `sample_raid_bundle`: RaidBundle with mixed item types
- `sample_config`: ProjectOutputConfig with Smartsheet settings

Test cases for POST /integration:
- `test_integration_success`: Full pipeline with mocked adapters
- `test_integration_dry_run`: Verify no writes/notifications in dry run
- `test_integration_smartsheet_only`: Config without notify_owners
- `test_integration_notifications_only`: Config without smartsheet_sheet_id
- `test_integration_no_config`: Uses default config
- `test_integration_smartsheet_failure`: Handle Smartsheet write failure
- `test_integration_notification_partial_failure`: Some notifications fail

Test cases for GET /integration/health:
- `test_health_all_configured`: Both adapters configured and healthy
- `test_health_smartsheet_only`: Only Smartsheet configured
- `test_health_none_configured`: Neither adapter configured

2. Use FastAPI TestClient with dependency overrides for mocking

3. Run: `uv run pytest tests/api/test_integration.py -v`
  </action>
  <verify>`uv run pytest tests/api/test_integration.py -v` - all tests pass</verify>
  <done>Integration API has comprehensive test coverage</done>
</task>

</tasks>

<verification>
1. `uv run python -c "from src.api.router import api_router; print([r.path for r in api_router.routes])"` - includes /integration
2. `uv run pytest tests/api/test_integration.py -v` - tests pass
3. `uv run pytest tests/integration/ -v` - all integration tests pass
4. `uv run pytest` - full suite passes (>340 tests)
5. Manual verification (optional): Start server and hit /integration/health
</verification>

<success_criteria>
- IntegrationRouter orchestrates SmartsheetAdapter + NotificationService
- POST /integration accepts RaidBundle, returns IntegrationResult
- GET /integration/health reports adapter status
- Action items written to Smartsheet rows
- Owners notified via Slack DM with item details
- Failures handled gracefully (partial success possible)
- Requirements OUT-03 and OUT-04 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/06-system-integration/06-03-SUMMARY.md`
</output>
