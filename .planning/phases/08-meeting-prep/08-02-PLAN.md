---
phase: 08-meeting-prep
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/adapters/slack_adapter.py
  - src/adapters/drive_adapter.py
  - src/prep/context_gatherer.py
  - tests/adapters/test_slack_adapter_extended.py
  - tests/adapters/test_drive_adapter_extended.py
  - tests/prep/test_context_gatherer.py
autonomous: true

must_haves:
  truths:
    - "SlackAdapter can fetch channel history for last N days"
    - "SlackAdapter can send Block Kit formatted prep DMs"
    - "DriveAdapter can search project docs by sharing or tags"
    - "ContextGatherer aggregates context from multiple sources in parallel"
  artifacts:
    - path: "src/adapters/slack_adapter.py"
      provides: "Extended with get_channel_history and send_prep_dm methods"
      contains: "async def get_channel_history"
    - path: "src/adapters/drive_adapter.py"
      provides: "Extended with search_project_docs method"
      contains: "async def search_project_docs"
    - path: "src/prep/context_gatherer.py"
      provides: "ContextGatherer service for parallel context aggregation"
      exports: ["ContextGatherer", "PrepContext"]
  key_links:
    - from: "src/prep/context_gatherer.py"
      to: "src/adapters/slack_adapter.py"
      via: "get_channel_history call"
      pattern: "slack.*get_channel_history"
    - from: "src/prep/context_gatherer.py"
      to: "src/adapters/drive_adapter.py"
      via: "search_project_docs call"
      pattern: "drive.*search_project_docs"
---

<objective>
Extend SlackAdapter with channel history and Block Kit DMs, extend DriveAdapter with doc search, and create ContextGatherer service.

Purpose: Meeting prep needs context from Slack (recent channel activity) and Drive (project docs). SlackAdapter already has send_dm but needs Block Kit support and channel history. DriveAdapter needs doc search. ContextGatherer orchestrates parallel context retrieval.

Output: Extended adapters for Slack and Drive, ContextGatherer service that aggregates context in parallel.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-meeting-prep/08-CONTEXT.md
@.planning/phases/08-meeting-prep/08-RESEARCH.md
@src/adapters/slack_adapter.py
@src/adapters/drive_adapter.py
@src/search/fts_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend SlackAdapter with channel history and Block Kit DMs</name>
  <files>
    - src/adapters/slack_adapter.py
    - tests/adapters/test_slack_adapter_extended.py
  </files>
  <action>
Extend `src/adapters/slack_adapter.py` with two new methods:

**get_channel_history method:**
```python
async def get_channel_history(
    self,
    channel_id: str,
    days: int = 7,
    limit: int = 100,
) -> list[dict]:
```
- Uses `conversations_history` API with `oldest` timestamp (now - days)
- Returns list of message dicts (text, user, ts, thread_ts if reply)
- Handle `channel_not_found` error gracefully (return empty list)
- Use standard error logging pattern from existing methods

**send_prep_dm method:**
```python
async def send_prep_dm(
    self,
    user_id: str,
    blocks: list[dict],
    text_fallback: str,
) -> dict:
```
- Uses `chat_postMessage` with `blocks` parameter for Block Kit
- `text_fallback` used for notification preview
- Returns `{"success": True, "ts": ...}` or `{"success": False, "error": ...}`
- Same error handling pattern as existing send_dm

**Import additions:**
- `from datetime import datetime, timedelta, timezone`

**Tests (test_slack_adapter_extended.py):**
- Mock `conversations_history` for get_channel_history
- Test days parameter converts to correct oldest timestamp
- Test empty channel returns empty list
- Test channel_not_found returns empty list (not raises)
- Mock `chat_postMessage` for send_prep_dm with blocks
- Test blocks passed correctly
- Test error responses handled
  </action>
  <verify>
`pytest tests/adapters/test_slack_adapter_extended.py -v` passes
  </verify>
  <done>
SlackAdapter.get_channel_history fetches messages from last N days; SlackAdapter.send_prep_dm sends Block Kit formatted messages
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend DriveAdapter and create ContextGatherer</name>
  <files>
    - src/adapters/drive_adapter.py
    - src/prep/context_gatherer.py
    - tests/adapters/test_drive_adapter_extended.py
    - tests/prep/test_context_gatherer.py
  </files>
  <action>
**Extend src/adapters/drive_adapter.py:**

Add `search_project_docs` method:
```python
async def search_project_docs(
    self,
    folder_id: str,
    query_terms: list[str] | None = None,
    max_results: int = 10,
    modified_after: datetime | None = None,
) -> list[dict]:
```
- Uses `files().list()` with query building:
  - Base: `'{folder_id}' in parents and trashed = false`
  - If query_terms: add `and (name contains '{term}' or fullText contains '{term}')`
  - If modified_after: add `and modifiedTime > '{iso_date}'`
- Returns list with: id, name, webViewLink, modifiedTime, mimeType
- Order by modifiedTime desc (recent first per CONTEXT.md)
- Use asyncio.to_thread for non-blocking

**Create src/prep/context_gatherer.py:**

```python
@dataclass
class PrepContext:
    open_items: list[dict]       # From ItemMatcher
    related_docs: list[dict]     # From DriveAdapter
    slack_highlights: list[dict] # From SlackAdapter
    previous_meeting: dict | None # Most recent in series
```

**ContextGatherer class:**
```python
class ContextGatherer:
    def __init__(
        self,
        item_matcher: ItemMatcher,
        drive_adapter: DriveAdapter | None,
        slack_adapter: SlackAdapter | None,
        fts_service: FTSService,
    ):
```
- Adapters are optional (graceful degradation if not configured)

**gather_for_meeting method:**
```python
async def gather_for_meeting(
    self,
    meeting: CalendarEvent,
    project_id: str,
    project_folder_id: str | None = None,
    slack_channel_id: str | None = None,
    lookback_days: int = 90,
) -> PrepContext:
```
- Extract attendee_emails from meeting.attendees
- Run all queries in parallel with `asyncio.gather`:
  1. `item_matcher.get_items_for_prep(attendee_emails, project_id, lookback_days)`
  2. `drive_adapter.search_project_docs(project_folder_id)` if folder_id provided
  3. `slack_adapter.get_channel_history(slack_channel_id, days=7)` if channel_id provided
  4. `_get_previous_meeting(meeting)` using FTS to find similar titled meetings
- Return PrepContext with all gathered data
- Handle individual failures gracefully (log, return empty for that source)

**_get_previous_meeting helper:**
- Use `normalize_series_key(meeting.summary)` to find meetings in same series
- Query meetings_projection for matching title pattern, before current meeting date
- Return most recent match or None

**normalize_series_key function** (per RESEARCH.md):
- Strip date patterns (MM/DD, MM-DD-YYYY, etc)
- Strip standalone numbers (week numbers)
- Lowercase and strip whitespace
- Return normalized string for series matching

**Tests:**
- test_drive_adapter_extended.py: Mock files().list() for search_project_docs
- test_context_gatherer.py:
  - Test parallel gathering (all sources return)
  - Test graceful degradation (missing adapters skip that source)
  - Test individual source failures don't block others
  - Test normalize_series_key with various meeting titles
  </action>
  <verify>
`pytest tests/adapters/test_drive_adapter_extended.py tests/prep/test_context_gatherer.py -v` passes
  </verify>
  <done>
DriveAdapter.search_project_docs returns docs from folder; ContextGatherer.gather_for_meeting retrieves items, docs, Slack context, and previous meeting in parallel
  </done>
</task>

</tasks>

<verification>
- `pytest tests/adapters/test_slack_adapter_extended.py tests/adapters/test_drive_adapter_extended.py tests/prep/test_context_gatherer.py -v` all pass
- `ruff check src/adapters/slack_adapter.py src/adapters/drive_adapter.py src/prep/context_gatherer.py` no errors
- SlackAdapter extensions handle errors gracefully
- DriveAdapter searches docs in specified folder
- ContextGatherer aggregates in parallel without blocking on individual failures
</verification>

<success_criteria>
1. SlackAdapter.get_channel_history returns messages from last N days (default 7)
2. SlackAdapter.send_prep_dm sends Block Kit blocks with text fallback
3. DriveAdapter.search_project_docs returns docs from folder, ordered by modifiedTime desc
4. ContextGatherer.gather_for_meeting runs all context queries in parallel
5. Missing adapters (None) cause graceful degradation, not errors
6. Individual adapter failures logged but don't block other sources
7. normalize_series_key correctly strips dates and numbers for meeting series matching
8. All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/08-meeting-prep/08-02-SUMMARY.md`
</output>
