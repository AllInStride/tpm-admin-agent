---
phase: 10-identity-service-wiring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "IdentityResolver is available via app.state.identity_resolver at runtime"
    - "RosterAdapter is available via app.state.roster_adapter at runtime"
    - "POST /identity/resolve endpoint responds without AttributeError"
    - "POST /identity/confirm endpoint responds without AttributeError"
  artifacts:
    - path: "src/main.py"
      provides: "Identity service initialization in lifespan"
      contains: "_initialize_identity_service"
  key_links:
    - from: "src/main.py"
      to: "src/identity/resolver.py"
      via: "IdentityResolver instantiation in lifespan"
      pattern: "IdentityResolver\\("
    - from: "src/main.py"
      to: "src/adapters/roster_adapter.py"
      via: "RosterAdapter instantiation in lifespan"
      pattern: "RosterAdapter\\("
    - from: "src/main.py"
      to: "app.state.identity_resolver"
      via: "state assignment"
      pattern: "app\\.state\\.identity_resolver\\s*="
    - from: "src/main.py"
      to: "app.state.roster_adapter"
      via: "state assignment"
      pattern: "app\\.state\\.roster_adapter\\s*="
---

<objective>
Wire IdentityResolver and RosterAdapter into main.py lifespan so identity API endpoints work at runtime.

Purpose: Close the integration gap identified in v1.0 milestone audit where identity endpoints fail with AttributeError because app.state.identity_resolver and app.state.roster_adapter are never initialized.

Output: Updated main.py with identity service initialization; all identity endpoints functional.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v1.0-MILESTONE-AUDIT.md

# Source files to modify/reference
@src/main.py
@src/api/identity.py
@src/identity/resolver.py
@src/identity/fuzzy_matcher.py
@src/repositories/mapping_repo.py
@src/adapters/roster_adapter.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add identity service initialization function to main.py</name>
  <files>src/main.py</files>
  <action>
Add `_initialize_identity_service` function to main.py following the established pattern used by `_initialize_communication_service` and `_initialize_prep_service`.

The function should:
1. Import required classes inside the function (lazy imports to avoid circular dependencies):
   - `from src.adapters.roster_adapter import RosterAdapter`
   - `from src.identity.fuzzy_matcher import FuzzyMatcher`
   - `from src.identity.resolver import IdentityResolver`
   - `from src.repositories.mapping_repo import MappingRepository`

2. Create instances:
   - `roster_adapter = RosterAdapter()` (uses GOOGLE_SHEETS_CREDENTIALS env var)
   - `fuzzy_matcher = FuzzyMatcher()` (default threshold 0.85)
   - `mapping_repo = MappingRepository(db)` (needs db client for learned mappings)
   - Call `await mapping_repo.initialize()` to create the learned_mappings table

3. Create IdentityResolver with dependencies:
   ```python
   identity_resolver = IdentityResolver(
       fuzzy_matcher=fuzzy_matcher,
       mapping_repo=mapping_repo,
   )
   ```
   Note: slack_adapter and calendar_adapter are optional per resolver.py:43-50. Skip for now - multi-source verification already handled in prep_service.

4. Assign to app.state:
   - `app.state.roster_adapter = roster_adapter`
   - `app.state.identity_resolver = identity_resolver`

5. Log initialization: `logger.info("Identity service initialized")`

Place function after `_initialize_communication_service` (around line 63) to maintain organization.
  </action>
  <verify>grep -n "_initialize_identity_service" src/main.py shows function definition</verify>
  <done>Function exists with RosterAdapter, FuzzyMatcher, MappingRepository, and IdentityResolver instantiation</done>
</task>

<task type="auto">
  <name>Task 2: Call identity service initialization in lifespan</name>
  <files>src/main.py</files>
  <action>
In the `lifespan` function, add call to `_initialize_identity_service` AFTER search services initialization (after line 196: "Search and dashboard services initialized") and BEFORE communication service initialization (before line 199).

Why this order:
- Identity service needs `db` client (available after line 151)
- Identity service does NOT depend on communication or prep services
- Communication and prep services do NOT depend on identity service
- Place after search services to group all "service initialization" together

Add this line:
```python
await _initialize_identity_service(app, db)
```

The lifespan sequence should be:
1. Database connection
2. Event store
3. Event bus
4. Projection repository and builder
5. Search and dashboard services
6. Identity service  <-- NEW
7. Communication service
8. Prep service and scheduler
  </action>
  <verify>grep -A5 "Search and dashboard services initialized" src/main.py shows identity_service call</verify>
  <done>_initialize_identity_service called in lifespan after search services, before communication service</done>
</task>

<task type="auto">
  <name>Task 3: Verify identity endpoints work at runtime</name>
  <files>src/main.py</files>
  <action>
Run the test suite to confirm no regressions, then verify the identity endpoints are accessible:

1. Run existing tests: `uv run pytest tests/ -v --tb=short`
2. Check that identity-related tests still pass
3. Start the app briefly and verify state initialization:
   - The app should start without errors
   - Check logs show "Identity service initialized"

Note: Full end-to-end testing of /identity/resolve requires GOOGLE_SHEETS_CREDENTIALS configured with a valid roster spreadsheet. The wiring is complete when:
- App starts without error
- app.state.identity_resolver is set (AttributeError would crash startup if broken)
- app.state.roster_adapter is set
  </action>
  <verify>uv run pytest tests/ -v --tb=short passes all tests; app starts with "Identity service initialized" in logs</verify>
  <done>All tests pass; app starts successfully with identity service initialized</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Code verification:
   - `_initialize_identity_service` function exists in main.py
   - Function creates RosterAdapter, FuzzyMatcher, MappingRepository, IdentityResolver
   - Function assigns to app.state.roster_adapter and app.state.identity_resolver
   - Function called in lifespan after search services

2. Runtime verification:
   - `uv run pytest tests/` passes (no regressions)
   - App starts without AttributeError
   - Logs show "Identity service initialized"

3. Gap closure verification:
   - The AttributeError described in v1.0-MILESTONE-AUDIT.md is resolved
   - /identity/resolve endpoint can accept requests (actual resolution requires credentials)
</verification>

<success_criteria>
- IdentityResolver is initialized in main.py lifespan and assigned to app.state
- RosterAdapter is initialized in main.py lifespan and assigned to app.state
- MappingRepository table is created via initialize() call
- All existing tests pass
- App starts successfully with "Identity service initialized" log message
- Identity API endpoints no longer raise AttributeError for missing state attributes
</success_criteria>

<output>
After completion, create `.planning/phases/10-identity-service-wiring/10-01-SUMMARY.md`
</output>
