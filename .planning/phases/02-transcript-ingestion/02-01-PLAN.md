---
phase: 02-transcript-ingestion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/api/meetings.py
  - src/api/router.py
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "POST /meetings/upload accepts multipart/form-data with file field"
    - "Endpoint rejects files without .vtt or .srt extension with 415"
    - "Endpoint rejects empty files with 400"
    - "Endpoint rejects files larger than 10MB with 413"
    - "Endpoint decodes UTF-8 and Latin-1 encoded files"
  artifacts:
    - path: "src/api/meetings.py"
      provides: "Upload endpoint with validation"
      exports: ["router"]
    - path: "pyproject.toml"
      provides: "python-multipart dependency"
      contains: "python-multipart"
  key_links:
    - from: "src/api/router.py"
      to: "src/api/meetings.py"
      via: "include_router"
      pattern: "from src\\.api\\.meetings import router"
---

<objective>
Create the transcript upload API endpoint with comprehensive file validation.

Purpose: ING-01 requires users to upload Zoom transcript files. This plan creates the upload endpoint with validation that rejects invalid files early with clear error messages.

Output: Working POST /meetings/upload endpoint that accepts VTT/SRT files and returns validation errors for invalid inputs.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-transcript-ingestion/02-RESEARCH.md

# Existing code to reference
@src/main.py
@src/api/router.py
@src/api/health.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add python-multipart dependency</name>
  <files>pyproject.toml</files>
  <action>
Run `uv add python-multipart` to add the dependency required by FastAPI for multipart/form-data file uploads.

Verify it appears in pyproject.toml dependencies.
  </action>
  <verify>`uv pip list | grep python-multipart` shows the package installed</verify>
  <done>python-multipart is in pyproject.toml and installed</done>
</task>

<task type="auto">
  <name>Task 2: Create meetings API with upload endpoint</name>
  <files>src/api/meetings.py, src/api/router.py</files>
  <action>
Create `src/api/meetings.py` with:

1. Import dependencies:
   - `from fastapi import APIRouter, UploadFile, HTTPException`
   - `from pathlib import Path`

2. Define constants:
   - `ALLOWED_EXTENSIONS = {".vtt", ".srt"}`
   - `MAX_FILE_SIZE_BYTES = 10 * 1024 * 1024` (10 MB)

3. Create router: `router = APIRouter(prefix="/meetings", tags=["meetings"])`

4. Create `validate_transcript_file(file: UploadFile) -> tuple[str, str]` async function:
   - Check filename exists (400 if missing)
   - Check extension is .vtt or .srt (415 if not)
   - Read content with `await file.read()`
   - Check not empty (400 if empty)
   - Check size <= MAX_FILE_SIZE_BYTES (413 if too large)
   - Decode with UTF-8-sig first, fall back to Latin-1 (400 if both fail)
   - Return tuple of (decoded_content, extension)

5. Create POST endpoint `/upload`:
   - Accept `file: UploadFile` parameter
   - Call validate_transcript_file
   - For now, return a simple JSON response: `{"status": "validated", "filename": file.filename, "size": len(content), "format": ext}`
   - The actual parsing will be wired in Plan 02-03

6. Update `src/api/router.py`:
   - Import: `from src.api.meetings import router as meetings_router`
   - Add: `api_router.include_router(meetings_router)`
  </action>
  <verify>
Run the server: `cd /Users/gabrielguenette/projects/tpm-admin-agent && uv run python -m src.main &`
Wait 2 seconds, then test:
- `curl -X POST http://localhost:8000/meetings/upload` returns 422 (missing file)
- Create test file: `echo "WEBVTT" > /tmp/test.vtt`
- `curl -X POST -F "file=@/tmp/test.vtt" http://localhost:8000/meetings/upload` returns 200 with status:validated
- `echo "" > /tmp/empty.vtt && curl -X POST -F "file=@/tmp/empty.vtt" http://localhost:8000/meetings/upload` returns 400
- `echo "test" > /tmp/test.txt && curl -X POST -F "file=@/tmp/test.txt" http://localhost:8000/meetings/upload` returns 415
Kill the server after testing.
  </verify>
  <done>
- POST /meetings/upload accepts VTT/SRT files
- Returns 415 for unsupported extensions
- Returns 400 for empty files or missing filename
- Returns 413 for files over 10MB
- Handles UTF-8 and Latin-1 encoding
  </done>
</task>

</tasks>

<verification>
1. Run `uv run pytest` - existing tests should still pass
2. Manual test: Upload a valid .vtt file and verify 200 response
3. Manual test: Upload an invalid extension and verify 415 response
4. Manual test: Upload an empty file and verify 400 response
</verification>

<success_criteria>
- python-multipart dependency added
- POST /meetings/upload endpoint exists and handles file uploads
- All validation cases return appropriate HTTP status codes
- Endpoint is registered in the API router
</success_criteria>

<output>
After completion, create `.planning/phases/02-transcript-ingestion/02-01-SUMMARY.md`
</output>
