---
phase: 09-communication-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/communication/__init__.py
  - src/communication/schemas.py
  - src/communication/prompts.py
  - src/communication/data_aggregator.py
  - src/communication/templates/exec_status.md.j2
  - src/communication/templates/exec_status.txt.j2
  - src/communication/templates/team_status.md.j2
  - src/communication/templates/team_status.txt.j2
  - src/communication/templates/escalation_email.txt.j2
  - src/communication/templates/talking_points.md.j2
  - tests/communication/__init__.py
  - tests/communication/test_schemas.py
  - tests/communication/test_data_aggregator.py
autonomous: true

must_haves:
  truths:
    - "Data aggregator can query items created within a time period"
    - "Data aggregator can query items completed within a time period"
    - "Data aggregator can identify blockers from open items"
    - "Schemas validate LLM output structure for all artifact types"
    - "Templates render status updates with RAG indicators"
  artifacts:
    - path: "src/communication/schemas.py"
      provides: "Output schemas for exec status, team status, escalation, talking points"
      exports: ["ExecStatusOutput", "TeamStatusOutput", "EscalationOutput", "TalkingPointsOutput", "GeneratedArtifact", "EscalationRequest", "StatusData"]
    - path: "src/communication/prompts.py"
      provides: "LLM prompts for all four artifact types"
      exports: ["EXEC_STATUS_PROMPT", "TEAM_STATUS_PROMPT", "ESCALATION_PROMPT", "TALKING_POINTS_PROMPT"]
    - path: "src/communication/data_aggregator.py"
      provides: "StatusData aggregation from repositories"
      exports: ["DataAggregator", "StatusData"]
    - path: "src/communication/templates/exec_status.md.j2"
      provides: "Markdown template for exec status with RAG badges"
      contains: "overall_rag"
  key_links:
    - from: "src/communication/data_aggregator.py"
      to: "src/repositories/open_items_repo.py"
      via: "OpenItemsRepository injection"
      pattern: "open_items_repo.*get_items"
    - from: "src/communication/data_aggregator.py"
      to: "src/repositories/projection_repo.py"
      via: "ProjectionRepository injection"
      pattern: "projection_repo"
---

<objective>
Create the foundation for communication automation: schemas for LLM structured outputs, prompts for all four artifact types, data aggregator for gathering RAID items and meetings by time period, and Jinja2 templates for final rendering.

Purpose: Establishes the data layer and output contracts that all generators will use.
Output: Schemas, prompts, aggregator, and templates ready for generator implementation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-communication-automation/09-CONTEXT.md
@.planning/phases/09-communication-automation/09-RESEARCH.md

# Existing infrastructure to integrate with
@src/services/llm_client.py
@src/repositories/open_items_repo.py
@src/repositories/projection_repo.py
@src/output/renderer.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schemas, prompts, and data aggregator</name>
  <files>
    src/communication/__init__.py
    src/communication/schemas.py
    src/communication/prompts.py
    src/communication/data_aggregator.py
    tests/communication/__init__.py
    tests/communication/test_schemas.py
    tests/communication/test_data_aggregator.py
  </files>
  <action>
Create `src/communication/` module with:

**schemas.py:**
- `StatusData` dataclass: project_id, time_period (tuple[datetime, datetime]), completed_items (list[dict]), new_items (list[dict]), open_items (list[dict]), decisions (list[dict]), risks (list[dict]), issues (list[dict]), blockers (list[dict]), meetings_held (list[dict]), item_velocity (int), overdue_count (int)
- `ExecStatusOutput(BaseModel)`: overall_rag, scope_rag, schedule_rag, risk_rag (all str), summary (str), key_progress (list[str]), key_decisions (list[str]), blockers (list[dict] with title/problem/ask), risks (list[str]), next_period (list[str])
- `TeamStatusOutput(BaseModel)`: summary (str), completed_items (list[dict] with description/owner/completed_date), open_items (list[dict] with description/owner/due_date/status), decisions (list[str]), risks (list[str]), issues (list[str])
- `EscalationOutput(BaseModel)`: subject (str), problem (str), impact (str), deadline (str), options (list[dict] with label/description/pros/cons), recommendation (str | None), context_summary (str | None)
- `TalkingPointsOutput(BaseModel)`: narrative_summary (str), key_points (list[str]), anticipated_qa (list[dict] with category/question/answer)
- `GeneratedArtifact(BaseModel)`: artifact_type (str), markdown (str), plain_text (str), metadata (dict)
- `EscalationRequest(BaseModel)`: problem_description (str), timeline_impact (str | None), resource_impact (str | None), business_impact (str | None), history_context (str | None), options (list[dict]), decision_deadline (datetime), recipient (str | None)

**prompts.py:**
- `EXEC_STATUS_PROMPT`: Template with placeholders for project_name, period_start, period_end, completed_items, new_items, open_items, decisions, risks, issues, blockers, meetings_count. Instructions per CONTEXT.md: half page, 5-7 bullets, teams not names, RAG indicators, blockers with explicit ask, next period section. RAG rules: GREEN=on track, AMBER=at risk, RED=off track.
- `TEAM_STATUS_PROMPT`: Template with placeholders. Instructions: detailed action items with owners/dates, completed items section first to celebrate wins, meeting notes aggregated.
- `ESCALATION_PROMPT`: Template with problem_description, impacts, history, options, deadline. Instructions: Problem-Impact-Ask format, explicit deadline, 2-3 options, matter-of-fact tone.
- `TALKING_POINTS_PROMPT`: Template with project/meeting/data context. Instructions: key bullet points, anticipated Q&A (risk/concern, resource, other categories), narrative focus with data.

**data_aggregator.py:**
- `DataAggregator` class with __init__ taking open_items_repo (OpenItemsRepository) and projection_repo (ProjectionRepository)
- `gather_for_status(project_id: str, since: datetime, until: datetime | None = None) -> StatusData`:
  - Query open items (status NOT IN closed statuses)
  - Query completed items (status IN closed statuses, updated in period)
  - Query new items (created_at in period)
  - Query meetings (date in period)
  - Derive blockers (items with due_date < now or flagged as blocking)
  - Derive decisions, risks, issues by item_type
  - Calculate velocity (completed - new)
  - Calculate overdue count

Create tests for schema validation and aggregator queries using mock repositories.
  </action>
  <verify>
`uv run pytest tests/communication/test_schemas.py tests/communication/test_data_aggregator.py -v` passes
  </verify>
  <done>
Schemas validate all artifact types, prompts have correct placeholders, aggregator queries items by time period
  </done>
</task>

<task type="auto">
  <name>Task 2: Jinja2 templates for all artifact types</name>
  <files>
    src/communication/templates/exec_status.md.j2
    src/communication/templates/exec_status.txt.j2
    src/communication/templates/team_status.md.j2
    src/communication/templates/team_status.txt.j2
    src/communication/templates/escalation_email.txt.j2
    src/communication/templates/talking_points.md.j2
  </files>
  <action>
Create `src/communication/templates/` directory with:

**exec_status.md.j2:**
```jinja2
# Status Update: {{ project_name }}

**Period:** {{ period_start }} - {{ period_end }}
**Overall Status:** {{ overall_rag }}

## RAG Breakdown

| Dimension | Status |
|-----------|--------|
| Scope | {{ scope_rag }} |
| Schedule | {{ schedule_rag }} |
| Risk | {{ risk_rag }} |

## Summary

{{ summary }}

## Key Progress

{% for item in key_progress %}
- {{ item }}
{% endfor %}

{% if key_decisions %}
## Decisions Made

{% for decision in key_decisions %}
- {{ decision }}
{% endfor %}
{% endif %}

{% if blockers %}
## Blockers (Action Required)

{% for blocker in blockers %}
### {{ blocker.title }}

{{ blocker.problem }}

**Ask:** {{ blocker.ask }}

{% endfor %}
{% endif %}

{% if risks %}
## Active Risks

{% for risk in risks %}
- {{ risk }}
{% endfor %}
{% endif %}

## Next Period

{% for item in next_period %}
- {{ item }}
{% endfor %}

---
*Generated: {{ generated_at }}*
*Source meetings: {{ source_meetings | join(', ') }}*
```

**exec_status.txt.j2:** Plain text version without markdown formatting, suitable for email or Slack.

**team_status.md.j2:** Per CONTEXT.md - completed items first, full action item list with owners/dates, detailed format.

**team_status.txt.j2:** Plain text version.

**escalation_email.txt.j2:** Problem-Impact-Ask format with options table, explicit deadline, clear ask at end.

**talking_points.md.j2:** Narrative summary, numbered key points, Q&A section with categories.

All templates use Jinja2 control structures ({% if %}, {% for %}) and expect context matching the output schemas.
  </action>
  <verify>
Templates exist and are valid Jinja2: `uv run python -c "from jinja2 import Environment, FileSystemLoader; env = Environment(loader=FileSystemLoader('src/communication/templates')); [env.get_template(t) for t in ['exec_status.md.j2', 'exec_status.txt.j2', 'team_status.md.j2', 'team_status.txt.j2', 'escalation_email.txt.j2', 'talking_points.md.j2']]"`
  </verify>
  <done>
All six templates load successfully and contain expected sections
  </done>
</task>

</tasks>

<verification>
- [ ] `src/communication/` module exists with schemas.py, prompts.py, data_aggregator.py
- [ ] All six templates exist in `src/communication/templates/`
- [ ] `uv run pytest tests/communication/ -v` passes
- [ ] Templates are valid Jinja2 (can be loaded without errors)
</verification>

<success_criteria>
- Schemas define contracts for all four artifact types (exec status, team status, escalation, talking points)
- Prompts include all required placeholders and instructions per CONTEXT.md
- DataAggregator can query items by time period using existing repositories
- Templates render properly with mock data
</success_criteria>

<output>
After completion, create `.planning/phases/09-communication-automation/09-01-SUMMARY.md`
</output>
