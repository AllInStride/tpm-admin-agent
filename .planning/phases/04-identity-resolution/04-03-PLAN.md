---
phase: 04-identity-resolution
plan: 03
type: execute
wave: 3
depends_on: [04-02]
files_modified:
  - src/adapters/__init__.py
  - src/adapters/roster_adapter.py
  - src/api/identity.py
  - src/api/router.py
  - tests/adapters/__init__.py
  - tests/adapters/test_roster_adapter.py
  - tests/api/test_identity.py
autonomous: true
user_setup:
  - service: google-sheets
    why: "Reading project roster from Google Sheets"
    env_vars:
      - name: GOOGLE_SHEETS_CREDENTIALS
        source: "GCP Console -> APIs & Services -> Credentials -> Create Service Account -> Download JSON"
    dashboard_config:
      - task: "Share roster spreadsheet with service account email"
        location: "Google Sheets -> Share -> Add service account email as viewer"

must_haves:
  truths:
    - "System matches names against project roster from Google Sheets (IDN-01)"
    - "System flags low-confidence matches (<85%) for human review (IDN-04)"
    - "User can confirm or reject identity matches"
    - "Confirmed matches are learned for future resolution"
  artifacts:
    - path: "src/adapters/roster_adapter.py"
      provides: "RosterAdapter for loading roster from Google Sheets"
      exports: ["RosterAdapter"]
    - path: "src/api/identity.py"
      provides: "Identity resolution and review endpoints"
      exports: ["router"]
  key_links:
    - from: "src/api/identity.py"
      to: "src/identity/resolver.py"
      via: "IdentityResolver dependency"
      pattern: "from src\\.identity import IdentityResolver"
    - from: "src/adapters/roster_adapter.py"
      to: "gspread"
      via: "Google Sheets API"
      pattern: "import gspread"
---

<objective>
Create roster adapter for Google Sheets and identity resolution API endpoints with human review workflow.

Purpose: This plan delivers the user-facing API for identity resolution. The roster adapter loads project rosters from Google Sheets. The API endpoints allow resolving names and submitting corrections that become learned mappings.
Output: RosterAdapter for Google Sheets, identity API with resolve and review endpoints
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-identity-resolution/04-CONTEXT.md
@.planning/phases/04-identity-resolution/04-RESEARCH.md
@src/identity/resolver.py
@src/identity/schemas.py
@src/api/extraction.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add gspread dependency and create RosterAdapter</name>
  <files>
    - pyproject.toml
    - src/adapters/__init__.py
    - src/adapters/roster_adapter.py
    - tests/adapters/__init__.py
    - tests/adapters/test_roster_adapter.py
  </files>
  <action>
1. Add gspread>=6.1.0 and google-auth>=2.36.0 to dependencies in pyproject.toml

2. Create src/adapters/__init__.py with module docstring

3. Create src/adapters/roster_adapter.py:

```python
class RosterAdapter:
    """Adapter for loading project rosters from Google Sheets.

    Expected sheet format (per CONTEXT.md):
    - Required columns: Name, Email
    - Optional columns: Slack handle, Role, Aliases (comma-separated)
    """

    def __init__(self, credentials_path: str | None = None):
        """Initialize with service account credentials.

        Args:
            credentials_path: Path to service account JSON.
                             Falls back to GOOGLE_SHEETS_CREDENTIALS env var.
        """
        self._credentials_path = credentials_path or os.environ.get(
            "GOOGLE_SHEETS_CREDENTIALS"
        )
        self._client: gspread.Client | None = None

    def _get_client(self) -> gspread.Client:
        """Get or create authenticated gspread client."""
        if self._client is None:
            if not self._credentials_path:
                raise ValueError(
                    "No credentials. Set GOOGLE_SHEETS_CREDENTIALS env var "
                    "or pass credentials_path to constructor."
                )
            creds = ServiceAccountCredentials.from_service_account_file(
                self._credentials_path,
                scopes=[
                    "https://www.googleapis.com/auth/spreadsheets.readonly",
                    "https://www.googleapis.com/auth/drive.readonly"
                ]
            )
            self._client = gspread.authorize(creds)
        return self._client

    def load_roster(self, spreadsheet_id: str, sheet_name: str = "Roster") -> list[RosterEntry]:
        """Load roster from Google Sheet.

        Args:
            spreadsheet_id: Google Sheets ID (from URL)
            sheet_name: Name of worksheet (default: "Roster")

        Returns:
            List of RosterEntry objects

        Raises:
            ValueError: If required columns missing
        """
        client = self._get_client()
        spreadsheet = client.open_by_key(spreadsheet_id)
        worksheet = spreadsheet.worksheet(sheet_name)

        # Get all records as list of dicts (header row becomes keys)
        records = worksheet.get_all_records()

        # Validate required columns
        if not records:
            return []

        first_row = records[0]
        if "Name" not in first_row or "Email" not in first_row:
            raise ValueError(
                "Roster sheet must have 'Name' and 'Email' columns. "
                f"Found columns: {list(first_row.keys())}"
            )

        # Parse entries (best effort - skip malformed rows)
        entries = []
        for row in records:
            try:
                if row.get("Name") and row.get("Email"):
                    entries.append(RosterEntry.from_sheet_row(row))
            except Exception as e:
                logger.warning(f"Skipping malformed roster row: {row}. Error: {e}")

        return entries
```

4. Create tests/adapters/__init__.py as empty file

5. Create tests/adapters/test_roster_adapter.py:
   - test_from_sheet_row_parses_required_fields
   - test_from_sheet_row_parses_aliases
   - test_from_sheet_row_handles_missing_optional
   - test_load_roster_validates_required_columns
   - test_load_roster_skips_malformed_rows

Use mock for gspread client in tests - don't require real credentials.

6. Run `uv sync` to install new dependencies
  </action>
  <verify>
    - `python -c "import gspread; print('gspread installed')"` succeeds
    - `pytest tests/adapters/test_roster_adapter.py -v` all tests pass
    - RosterAdapter.load_roster returns list of RosterEntry
  </verify>
  <done>RosterAdapter loads project rosters from Google Sheets with validation</done>
</task>

<task type="auto">
  <name>Task 2: Create identity API endpoints</name>
  <files>
    - src/api/identity.py
    - src/api/router.py
    - tests/api/test_identity.py
  </files>
  <action>
1. Create src/api/identity.py:

```python
router = APIRouter(prefix="/identity", tags=["identity"])


class ResolveRequest(BaseModel):
    """Request to resolve names from extraction."""
    names: list[str] = Field(description="Names to resolve (from transcript)")
    project_id: str = Field(description="Project ID for roster lookup")
    roster_spreadsheet_id: str = Field(description="Google Sheets ID for roster")


class ResolvedIdentity(BaseModel):
    """Single resolved identity."""
    transcript_name: str
    resolved_email: str | None
    resolved_name: str | None
    confidence: float
    source: str
    requires_review: bool
    alternatives: list[tuple[str, float]] = []


class ResolveResponse(BaseModel):
    """Response with resolved identities."""
    resolved: list[ResolvedIdentity]
    pending_review_count: int = Field(description="Count needing human review")
    review_summary: str | None = Field(
        default=None,
        description="Human-readable summary if items need review"
    )


class ConfirmRequest(BaseModel):
    """Request to confirm/correct an identity match."""
    project_id: str
    transcript_name: str
    confirmed_email: str
    confirmed_name: str


class ConfirmResponse(BaseModel):
    """Response after confirming identity."""
    transcript_name: str
    confirmed_email: str
    confirmed_name: str
    learned: bool = Field(description="True if mapping was saved for future use")


@router.post("/resolve", response_model=ResolveResponse)
async def resolve_identities(
    request: ResolveRequest,
    # Dependencies injected
) -> ResolveResponse:
    """Resolve transcript names to project roster.

    Attempts to match each name against the project roster using:
    1. Exact match
    2. Learned mappings (from previous corrections)
    3. Fuzzy matching (Jaro-Winkler)
    4. LLM inference (for ambiguous cases)

    Returns matches with confidence scores. Items with confidence < 85%
    are flagged for human review (requires_review=True).
    """
    # Load roster from Google Sheets
    # Resolve each name
    # Build response with review summary


@router.post("/confirm", response_model=ConfirmResponse)
async def confirm_identity(
    request: ConfirmRequest,
    # Dependencies injected
) -> ConfirmResponse:
    """Confirm or correct an identity match.

    Saves the mapping for future resolution. Next time this transcript_name
    appears in this project, it will automatically resolve to confirmed_email.
    """
    # Save learned mapping
    # Return confirmation


@router.get("/pending/{project_id}", response_model=list[ResolvedIdentity])
async def get_pending_reviews(
    project_id: str,
    # Dependencies injected
) -> list[ResolvedIdentity]:
    """Get all identities pending review for a project.

    Returns items that were resolved but have requires_review=True
    and haven't been confirmed yet.
    """
    # Query pending reviews (would need a pending_reviews table)
    # For MVP, return empty list - reviews are handled inline in extraction response
    return []
```

2. Update src/api/router.py to include identity router:
   - Add `from src.api.identity import router as identity_router`
   - Include identity_router in main router

3. Create tests/api/test_identity.py:
   - test_resolve_returns_matches
   - test_resolve_marks_low_confidence_for_review
   - test_resolve_includes_review_summary
   - test_confirm_saves_mapping
   - test_confirm_returns_learned_true
   - test_resolve_uses_learned_mapping

Use mocks for RosterAdapter and IdentityResolver in tests.
  </action>
  <verify>
    - `pytest tests/api/test_identity.py -v` all tests pass
    - POST /identity/resolve accepts names and returns ResolveResponse
    - POST /identity/confirm saves mapping and returns ConfirmResponse
    - Review summary generated when pending_review_count > 0
  </verify>
  <done>Identity API endpoints for resolution and human review workflow</done>
</task>

</tasks>

<verification>
- All adapters tests pass: `pytest tests/adapters/ -v`
- All API tests pass: `pytest tests/api/test_identity.py -v`
- Server starts: `python -c "from src.api.identity import router"`
- Full test suite: `pytest tests/ -v` all pass
</verification>

<success_criteria>
- gspread dependency added and installed
- RosterAdapter loads roster from Google Sheets with column validation
- RosterAdapter handles malformed rows gracefully (skip with warning)
- POST /identity/resolve accepts names and returns ResolutionResult list
- Response includes pending_review_count and review_summary
- POST /identity/confirm saves learned mapping for future use
- Identity router registered in main API router
- All tests pass (10+ new tests)
- Requirements covered: IDN-01 (roster matching), IDN-04 (flags low confidence)
</success_criteria>

<output>
After completion, create `.planning/phases/04-identity-resolution/04-03-SUMMARY.md`
</output>
