---
phase: 04-identity-resolution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/identity/__init__.py
  - src/identity/schemas.py
  - src/identity/fuzzy_matcher.py
  - src/identity/confidence.py
  - tests/identity/__init__.py
  - tests/identity/test_fuzzy_matcher.py
  - tests/identity/test_confidence.py
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "System can fuzzy-match a transcript name against roster names"
    - "Match confidence is calculated using Jaro-Winkler similarity"
    - "Multi-source agreement boosts confidence above single-source cap"
    - "Single-source matches are capped at 85%"
  artifacts:
    - path: "src/identity/schemas.py"
      provides: "RosterEntry and ResolutionResult schemas"
      exports: ["RosterEntry", "ResolutionResult", "ResolutionSource"]
    - path: "src/identity/fuzzy_matcher.py"
      provides: "FuzzyMatcher with Jaro-Winkler name matching"
      exports: ["FuzzyMatcher"]
    - path: "src/identity/confidence.py"
      provides: "Multi-source confidence calculator"
      exports: ["calculate_confidence"]
  key_links:
    - from: "src/identity/fuzzy_matcher.py"
      to: "rapidfuzz"
      via: "JaroWinkler.normalized_similarity"
      pattern: "from rapidfuzz"
    - from: "src/identity/confidence.py"
      to: "src/identity/schemas.py"
      via: "schema imports"
      pattern: "from src\\.identity\\.schemas import"
---

<objective>
Create identity resolution foundation: schemas, fuzzy matcher, and confidence calculator.

Purpose: These are the core building blocks for name resolution. FuzzyMatcher handles string similarity with RapidFuzz (Jaro-Winkler for person names). Confidence calculator implements the multi-source boosting rules from CONTEXT.md.
Output: Identity module with schemas, fuzzy matcher, confidence calculator, and tests
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-identity-resolution/04-CONTEXT.md
@.planning/phases/04-identity-resolution/04-RESEARCH.md
@src/models/participant.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add RapidFuzz dependency and create identity module</name>
  <files>
    - pyproject.toml
    - src/identity/__init__.py
    - tests/identity/__init__.py
  </files>
  <action>
1. Add rapidfuzz>=3.14.0 to dependencies in pyproject.toml

2. Create src/identity/__init__.py with module docstring and empty exports (will be populated by later tasks)

3. Create tests/identity/__init__.py as empty file

4. Run `uv sync` to install new dependency
  </action>
  <verify>
    - `python -c "from rapidfuzz import fuzz, process; print('RapidFuzz installed')"` succeeds
    - `python -c "import src.identity"` succeeds
  </verify>
  <done>RapidFuzz installed and identity module scaffolded</done>
</task>

<task type="auto">
  <name>Task 2: Create identity resolution schemas</name>
  <files>
    - src/identity/schemas.py
    - src/identity/__init__.py
  </files>
  <action>
Create src/identity/schemas.py with Pydantic models per RESEARCH.md patterns:

1. RosterEntry model:
   - name: str (full name)
   - email: EmailStr (unique identifier)
   - slack_handle: str | None
   - role: str | None
   - aliases: list[str] (from comma-separated Aliases column)
   - @classmethod from_sheet_row(cls, row: dict) -> "RosterEntry" for parsing Google Sheets data

2. ResolutionSource enum (str, Enum):
   - EXACT = "exact"
   - LEARNED = "learned"
   - FUZZY = "fuzzy"
   - LLM = "llm"
   - CALENDAR = "calendar"
   - SLACK = "slack"

3. ResolutionResult model:
   - transcript_name: str (original from transcript)
   - resolved_email: str | None (matched person's email)
   - resolved_name: str | None (canonical name)
   - confidence: float (0.0-1.0)
   - source: ResolutionSource
   - alternatives: list[tuple[str, float]] = [] (other matches with scores)
   - requires_review: bool (True if confidence < 0.85)
   - @property is_resolved(self) -> bool: return resolved_email is not None and confidence >= 0.85

Update src/identity/__init__.py to export RosterEntry, ResolutionResult, ResolutionSource
  </action>
  <verify>
    - `python -c "from src.identity.schemas import RosterEntry, ResolutionResult, ResolutionSource; print('Schemas loaded')"` succeeds
    - RosterEntry has from_sheet_row classmethod
    - ResolutionResult.is_resolved returns False when confidence < 0.85
  </verify>
  <done>Identity schemas defined with RosterEntry for roster data and ResolutionResult for match results</done>
</task>

<task type="auto">
  <name>Task 3: Create FuzzyMatcher and confidence calculator with tests</name>
  <files>
    - src/identity/fuzzy_matcher.py
    - src/identity/confidence.py
    - src/identity/__init__.py
    - tests/identity/test_fuzzy_matcher.py
    - tests/identity/test_confidence.py
  </files>
  <action>
1. Create src/identity/fuzzy_matcher.py:

```python
class FuzzyMatcher:
    """Fuzzy name matching using RapidFuzz Jaro-Winkler."""

    def __init__(self, threshold: float = 0.85):
        self._threshold = threshold

    def find_best_match(
        self,
        query: str,
        roster: list[RosterEntry]
    ) -> tuple[RosterEntry | None, float]:
        """Find best matching roster entry for a name.

        Uses token_sort_ratio for name order independence
        (handles "John Smith" vs "Smith, John").

        Returns (matched_entry, score) or (None, 0.0) if no match above threshold.
        """
        # Build choices list including aliases
        # Use rapidfuzz.process.extractOne with token_sort_ratio scorer
        # Return best match or None

    def find_top_matches(
        self,
        query: str,
        roster: list[RosterEntry],
        limit: int = 3
    ) -> list[tuple[RosterEntry, float]]:
        """Find top N matches for alternatives display."""
```

Key implementation details:
- Use `from rapidfuzz import fuzz, process, utils`
- Use `processor=utils.default_process` for consistent preprocessing
- Use `scorer=fuzz.token_sort_ratio` (returns 0-100, normalize to 0-1)
- Include aliases in search (create expanded choices with alias -> entry mapping)
- Handle empty roster gracefully (return None, 0.0)

2. Create src/identity/confidence.py:

```python
def calculate_confidence(
    fuzzy_score: float,
    roster_match: bool,
    slack_match: bool = False,
    calendar_match: bool = False,
) -> float:
    """Calculate final confidence with multi-source boosting.

    Rules from CONTEXT.md:
    - Single-source (roster only) capped at 0.85
    - Multi-source agreement adds boost
    - Cannot exceed 1.0

    Args:
        fuzzy_score: Base score from fuzzy matching (0-1)
        roster_match: Match found in roster
        slack_match: Verified in Slack
        calendar_match: Verified in Calendar

    Returns:
        Final confidence score (0-1)
    """
    # If no roster match, no confidence
    if not roster_match:
        return 0.0

    base = fuzzy_score

    # Single-source cap per CONTEXT.md
    if not (slack_match or calendar_match):
        return min(base, 0.85)

    # Multi-source boost
    sources_agreeing = sum([roster_match, slack_match, calendar_match])
    if sources_agreeing >= 2:
        boost = 0.05 * (sources_agreeing - 1)
        return min(base + boost, 1.0)

    return base
```

3. Create tests/identity/test_fuzzy_matcher.py:
   - test_exact_match_returns_1_0
   - test_similar_name_scores_above_threshold
   - test_dissimilar_name_scores_below_threshold
   - test_alias_matches_entry
   - test_name_order_independence (John Smith = Smith, John)
   - test_empty_roster_returns_none
   - test_find_top_matches_returns_multiple

4. Create tests/identity/test_confidence.py:
   - test_single_source_capped_at_85
   - test_multi_source_boosts_confidence
   - test_no_roster_match_returns_zero
   - test_three_sources_boost_higher_than_two
   - test_cannot_exceed_1_0
   - test_exact_match_with_verification_returns_1_0

5. Update src/identity/__init__.py to export FuzzyMatcher, calculate_confidence
  </action>
  <verify>
    - `pytest tests/identity/ -v` all tests pass
    - At least 13 tests (7 fuzzy + 6 confidence)
    - `python -c "from src.identity import FuzzyMatcher, calculate_confidence"` succeeds
  </verify>
  <done>FuzzyMatcher with Jaro-Winkler matching and confidence calculator with multi-source boosting, fully tested</done>
</task>

</tasks>

<verification>
- RapidFuzz installed: `python -c "from rapidfuzz import fuzz"`
- All schemas load: `python -c "from src.identity import RosterEntry, ResolutionResult, ResolutionSource"`
- All tests pass: `pytest tests/identity/ -v`
- Single-source cap works: confidence calculator returns max 0.85 without verification
</verification>

<success_criteria>
- RapidFuzz dependency added and installed
- RosterEntry schema parses Google Sheets row format
- ResolutionResult tracks match confidence and requires_review flag
- FuzzyMatcher uses Jaro-Winkler with token_sort_ratio for name independence
- Confidence calculator implements single-source 85% cap and multi-source boosting
- All tests pass (13+ tests)
</success_criteria>

<output>
After completion, create `.planning/phases/04-identity-resolution/04-01-SUMMARY.md`
</output>
